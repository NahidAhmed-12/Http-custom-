<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notification Sender</title>
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 10px;
    }

    p {
      text-align: center;
      margin-bottom: 30px;
      color: #7f8c8d;
    }

    .notification-form {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .send-button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s;
    }

    .send-button:hover {
      background-color: #2980b9;
    }

    #status-message {
      margin-top: 15px;
      text-align: center;
      min-height: 20px;
    }

    .permission-status {
      text-align: center;
      padding: 10px;
      background-color: #ecf0f1;
      border-radius: 4px;
    }

    .subscriber-count {
      margin-top: 10px;
      font-size: 14px;
    }

    .success {
      color: #27ae60;
    }

    .error {
      color: #e74c3c;
    }

    .info {
      color: #3498db;
    }

    .warning {
      color: #f39c12;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Notification Sender</h1>
    <p>Send push notifications to subscribed users</p>
    
    <div class="notification-form">
      <div class="form-group">
        <label for="notification-title">Notification Title</label>
        <input type="text" id="notification-title" placeholder="Enter notification title" required>
      </div>
      
      <div class="form-group">
        <label for="notification-message">Notification Message</label>
        <textarea id="notification-message" placeholder="Enter notification message" required></textarea>
      </div>
      
      <button id="send-button" class="send-button">Send Notification</button>
      <p id="status-message"></p>
      <p id="subscriber-count" class="subscriber-count info"></p>
    </div>
    
    <div class="permission-status">
      <p id="permission-text">Notification permission status: Unknown</p>
      <p id="player-id">Player ID: Not available yet</p>
    </div>
  </div>

  <script>
    // Initialize OneSignal
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "975d4661-9acf-4714-a57b-8627478647d3",
        safari_web_id: "web.onesignal.auto.552dcc8d-cced-4aac-823c-93a119513fed",
        notifyButton: {
          enable: true,
        },
      });

      // Get the current user's ID
      const playerId = await OneSignal.User.pushSubscription.getId();
      document.getElementById('player-id').textContent = `Player ID: ${playerId || 'Not subscribed'}`;
      
      // Update permission status display
      updatePermissionStatus();
      
      // Check permission when the page loads
      checkNotificationPermission();

      // Check subscriber count
      checkSubscriberCount();
    });

    // DOM elements
    const sendButton = document.getElementById('send-button');
    const titleInput = document.getElementById('notification-title');
    const messageInput = document.getElementById('notification-message');
    const statusMessage = document.getElementById('status-message');
    const permissionText = document.getElementById('permission-text');
    const subscriberCount = document.getElementById('subscriber-count');
    const playerIdElement = document.getElementById('player-id');

    // Update permission status text
    function updatePermissionStatus() {
      OneSignal.Notifications.permission.then(permission => {
        const status = permission ? 'Granted' : 'Denied';
        permissionText.textContent = `Notification permission status: ${status}`;
      });
    }

    // Check notification permission
    async function checkNotificationPermission() {
      try {
        const permission = await OneSignal.Notifications.permission;
        if (!permission) {
          statusMessage.textContent = "Please enable notifications to send messages.";
          statusMessage.className = "info";
        }
      } catch (error) {
        console.error("Error checking notification permission:", error);
        statusMessage.textContent = "Error checking notification permission.";
        statusMessage.className = "error";
      }
    }

    // Check how many subscribers we have
    async function checkSubscriberCount() {
      try {
        const response = await fetch('https://onesignal.com/api/v1/players?app_id=975d4661-9acf-4714-a57b-8627478647d3', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic os_v2_app_s5oumym2z5drjjl3qytupbsh2orozdxm5gduht4izoeh5re5ewzyxt2ge6jabnel5cip7pzwyl4zzou6pksqmu333h43viqscixjsoa'
          }
        });
        
        const data = await response.json();
        const totalSubscribers = data.total_count;
        const activeSubscribers = data.players.filter(p => p.notification_types === 1).length;
        
        subscriberCount.textContent = `Active subscribers: ${activeSubscribers} (Total users: ${totalSubscribers})`;
        subscriberCount.className = activeSubscribers > 0 ? "subscriber-count success" : "subscriber-count warning";
        
        if (activeSubscribers === 0) {
          statusMessage.textContent = "Warning: You currently have no active subscribers to receive notifications.";
          statusMessage.className = "warning";
        }
      } catch (error) {
        console.error("Error checking subscriber count:", error);
        subscriberCount.textContent = "Could not load subscriber count";
        subscriberCount.className = "subscriber-count error";
      }
    }

    // Send notification
    async function sendNotification(title, message) {
      try {
        statusMessage.textContent = "Sending notification...";
        statusMessage.className = "info";
        
        // First check if we have subscribers
        const response = await fetch('https://onesignal.com/api/v1/players?app_id=975d4661-9acf-4714-a57b-8627478647d3&limit=1', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic os_v2_app_s5oumym2z5drjjl3qytupbsh2orozdxm5gduht4izoeh5re5ewzyxt2ge6jabnel5cip7pzwyl4zzou6pksqmu333h43viqscixjsoa'
          }
        });
        
        const data = await response.json();
        const hasSubscribers = data.players.some(p => p.notification_types === 1);
        
        if (!hasSubscribers) {
          statusMessage.textContent = "Cannot send: No active subscribers available to receive notifications.";
          statusMessage.className = "error";
          return;
        }

        // If we have subscribers, send the notification
        const notificationResponse = await fetch('https://onesignal.com/api/v1/notifications', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic os_v2_app_s5oumym2z5drjjl3qytupbsh2orozdxm5gduht4izoeh5re5ewzyxt2ge6jabnel5cip7pzwyl4zzou6pksqmu333h43viqscixjsoa'
          },
          body: JSON.stringify({
            app_id: "975d4661-9acf-4714-a57b-8627478647d3",
            included_segments: ["Subscribed Users"],
            headings: { en: title },
            contents: { en: message },
            // Additional parameters for better tracking
            chrome_web_icon: "https://cdn.onesignal.com/sdks/OneSignal-Logo_600x300.png",
            url: window.location.href,
            web_push_topic: "general-notifications"
          })
        });
        
        const notificationData = await notificationResponse.json();
        
        if (notificationData.id) {
          statusMessage.textContent = "Notification sent successfully!";
          statusMessage.className = "success";
          
          // Log the successful notification details
          console.log("Notification sent successfully:", {
            notificationId: notificationData.id,
            recipients: notificationData.recipients,
            timestamp: new Date().toISOString()
          });
        } else {
          const errorMsg = notificationData.errors ? notificationData.errors.join(', ') : 'Unknown error';
          statusMessage.textContent = `Failed to send notification: ${errorMsg}`;
          statusMessage.className = "error";
          
          // Log the error details
          console.error("Notification failed:", {
            error: errorMsg,
            response: notificationData,
            timestamp: new Date().toISOString()
          });
        }
      } catch (error) {
        console.error("Error sending notification:", {
          error: error.message,
          timestamp: new Date().toISOString()
        });
        statusMessage.textContent = "Error sending notification: " + error.message;
        statusMessage.className = "error";
      }
    }

    // Event listener for send button
    sendButton.addEventListener('click', async () => {
      const title = titleInput.value.trim();
      const message = messageInput.value.trim();
      
      if (!title || !message) {
        statusMessage.textContent = "Please enter both title and message.";
        statusMessage.className = "error";
        return;
      }
      
      // Check permission before sending
      const permission = await OneSignal.Notifications.permission;
      if (!permission) {
        statusMessage.textContent = "You need to enable notifications first.";
        statusMessage.className = "error";
        return;
      }
      
      await sendNotification(title, message);
    });
  </script>
</body>
</html>
